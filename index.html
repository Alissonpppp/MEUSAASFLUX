<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FluxBlue Personal - Controle Financeiro</title>
    
    <!-- React, ReactDOM, Babel, Tailwind -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Charts & Utils -->
    <script src="https://unpkg.com/prop-types@15.8.1/prop-types.min.js"></script>
    <script src="https://unpkg.com/recharts@2.8.0/umd/Recharts.js"></script>
    
    <!-- Font: Inter -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <script>
        tailwind.config = {
            theme: {
                extend: {
                    fontFamily: { sans: ['Inter', 'sans-serif'] },
                    colors: { 
                        brand: { 50: '#eff6ff', 100: '#dbeafe', 500: '#3b82f6', 600: '#2563eb', 700: '#1d4ed8', 900: '#1e3a8a' },
                        slate: { 850: '#1e293b', 900: '#0f172a' }
                    }
                }
            }
        }
    </script>
    <style>
        body { background-color: #f8fafc; color: #1e293b; }
        ::-webkit-scrollbar { width: 6px; height: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .card-shadow { box-shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1); }
        .progress-bar-striped {
            background-image: linear-gradient(45deg,rgba(255,255,255,.15) 25%,transparent 25%,transparent 50%,rgba(255,255,255,.15) 50%,rgba(255,255,255,.15) 75%,transparent 75%,transparent);
            background-size: 1rem 1rem;
        }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useRef } = React;
        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer, PieChart, Pie, Cell, BarChart, Bar } = window.Recharts || {};

        // --- ÍCONES ---
        const Icons = {
            Home: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="m3 9 9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"/><polyline points="9 22 9 12 15 12 15 22"/></svg>,
            Wallet: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 12V7H5a2 2 0 0 1 0-4h14v4" /><path d="M3 5v14a2 2 0 0 0 2 2h16v-5" /><path d="M18 12a2 2 0 0 0 0 4h4v-4Z" /></svg>,
            Target: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="6"/><circle cx="12" cy="12" r="2"/></svg>,
            Chart: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M3 3v18h18" /><path d="m19 9-5 5-4-4-3 3" /></svg>,
            Bot: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"/><path d="M7 11V7a5 5 0 0 1 10 0v4"/><line x1="8" y1="16" x2="8" y2="16"/><line x1="16" y1="16" x2="16" y2="16"/><path d="M12 16v4"/><line x1="16" y1="11" x2="16" y2="7"/><line x1="8" y1="11" x2="8" y2="7"/></svg>,
            Trash: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>,
            LogOut: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"/><polyline points="16 17 21 12 16 7"/><line x1="21" y1="12" x2="9" y2="12"/></svg>,
            Download: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>,
            Settings: () => <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>,
            Send: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>,
            Plus: () => <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
        };

        // --- SISTEMA DADOS ---
        const DB_KEY = 'fluxblue_license_db';
        const APP_DATA_KEY = 'fluxblue_client_data_v3'; // Versão atualizada

        const ClientSystem = {
            init: () => {
                if (!localStorage.getItem(APP_DATA_KEY)) {
                    localStorage.setItem(APP_DATA_KEY, JSON.stringify({
                        transactions: [
                            { id: 1, type: 'income', desc: 'Salário Mensal', amount: 4500, date: new Date().toISOString(), category: 'Salário' },
                            { id: 2, type: 'expense', desc: 'Supermercado', amount: 890, date: new Date().toISOString(), category: 'Mercado' },
                        ],
                        goals: [
                            { id: 1, title: 'Reserva de Emergência', target: 10000, saved: 2500 }
                        ],
                        settings: { userName: 'Minha Família', incomeGoal: 6000 }
                    }));
                }
            },
            validate: (email, key) => {
                const db = JSON.parse(localStorage.getItem(DB_KEY) || '{"keys":[]}');
                const lic = db.keys.find(k => k.key === key);
                if (!lic) return { ok: false, msg: 'Chave não encontrada.' };
                if (new Date() > new Date(lic.expires)) return { ok: false, msg: 'Licença expirada.' };
                if (!lic.assignedEmail) {
                    lic.assignedEmail = email;
                    lic.status = 'active';
                    localStorage.setItem(DB_KEY, JSON.stringify(db));
                    return { ok: true, license: lic };
                } 
                if (lic.assignedEmail !== email) return { ok: false, msg: 'Chave pertence a outro usuário.' };
                return { ok: true, license: lic };
            },
            getData: () => JSON.parse(localStorage.getItem(APP_DATA_KEY)),
            saveData: (data) => localStorage.setItem(APP_DATA_KEY, JSON.stringify(data))
        };

        // --- TELAS ---

        const Login = ({ onSuccess }) => {
            const [email, setEmail] = useState('');
            const [key, setKey] = useState('');
            const [error, setError] = useState('');
            const [loading, setLoading] = useState(false);

            const handle = (e) => {
                e.preventDefault();
                setLoading(true); setError('');
                setTimeout(() => {
                    const res = ClientSystem.validate(email.trim(), key.trim());
                    if(res.ok) onSuccess(res.license, email);
                    else { setError(res.msg); setLoading(false); }
                }, 800);
            };

            return (
                <div className="min-h-screen flex items-center justify-center bg-slate-100 p-4">
                    <div className="max-w-md w-full bg-white rounded-xl shadow-lg p-8 border border-slate-200">
                        <div className="text-center mb-8">
                            <h1 className="text-3xl font-bold text-slate-800 tracking-tight">FluxBlue <span className="text-brand-600">Pessoal</span></h1>
                            <p className="text-slate-500 text-sm mt-1">Controle Financeiro Familiar</p>
                        </div>
                        <form onSubmit={handle} className="space-y-5">
                            <div>
                                <label className="block text-xs font-semibold text-slate-600 uppercase mb-1">Seu E-mail</label>
                                <input required type="email" className="w-full border border-slate-300 rounded-lg p-3 text-slate-800 outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition" value={email} onChange={e=>setEmail(e.target.value)} placeholder="voce@email.com" />
                            </div>
                            <div>
                                <label className="block text-xs font-semibold text-slate-600 uppercase mb-1">Chave de Acesso</label>
                                <input required type="text" className="w-full border border-slate-300 rounded-lg p-3 text-slate-800 font-mono uppercase outline-none focus:border-brand-500 focus:ring-1 focus:ring-brand-500 transition" value={key} onChange={e=>setKey(e.target.value)} placeholder="FLUX-XXXX-XXXX" />
                            </div>
                            {error && <div className="bg-red-50 text-red-600 text-sm p-3 rounded-lg border border-red-100 flex items-center gap-2">⚠️ {error}</div>}
                            <button disabled={loading} className="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-3 rounded-lg shadow-md transition-all">
                                {loading ? 'Entrando...' : 'Acessar Minha Conta'}
                            </button>
                        </form>
                    </div>
                </div>
            );
        };

        const AIChat = ({ data }) => {
            const [messages, setMessages] = useState([
                { id: 1, type: 'bot', text: 'Olá! Sou sua assistente. Pergunte sobre seus gastos, receitas ou peça dicas para economizar.' }
            ]);
            const [input, setInput] = useState('');

            const handleSend = (e) => {
                e.preventDefault();
                if(!input.trim()) return;
                
                const userMsg = { id: Date.now(), type: 'user', text: input };
                setMessages(prev => [...prev, userMsg]);
                setInput('');

                setTimeout(() => {
                    const totalExp = data.transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
                    const balance = data.transactions.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0) - totalExp;
                    
                    let responseText = '';
                    const lowerInput = userMsg.text.toLowerCase();

                    if(lowerInput.includes('gastei') || lowerInput.includes('despesa')) {
                        responseText = `Você gastou R$ ${totalExp.toFixed(2)} até agora. Lembre-se: dinheiro não aceita desaforo!`;
                    } else if (lowerInput.includes('saldo') || lowerInput.includes('sobrou')) {
                        responseText = `Seu saldo é R$ ${balance.toFixed(2)}. ${balance > 0 ? 'Bom trabalho, continue economizando!' : 'Atenção, você está no vermelho!'}`;
                    } else if (lowerInput.includes('dica') || lowerInput.includes('economizar')) {
                        responseText = "Dica de Ouro: Regra 50/30/20. 50% para necessidades, 30% para desejos e 20% para poupança. Tente aplicar isso hoje!";
                    } else {
                        responseText = "Posso analisar seus gastos ou dar dicas. Tente perguntar 'Quanto gastei?' ou 'Dica de economia'.";
                    }

                    setMessages(prev => [...prev, { id: Date.now()+1, type: 'bot', text: responseText }]);
                }, 800);
            };

            return (
                <div className="flex flex-col h-[calc(100vh-140px)] bg-white rounded-xl shadow-sm border border-slate-200 overflow-hidden">
                    <div className="flex-1 overflow-y-auto p-6 space-y-4 bg-slate-50">
                        {messages.map(msg => (
                            <div key={msg.id} className={`flex ${msg.type === 'user' ? 'justify-end' : 'justify-start'}`}>
                                <div className={`max-w-[80%] p-4 rounded-2xl text-sm ${msg.type === 'user' ? 'bg-brand-600 text-white rounded-br-none' : 'bg-white border border-slate-200 text-slate-700 rounded-bl-none shadow-sm'}`}>
                                    {msg.text}
                                </div>
                            </div>
                        ))}
                    </div>
                    <form onSubmit={handleSend} className="p-4 bg-white border-t border-slate-200 flex gap-2">
                        <input className="flex-1 border border-slate-300 rounded-lg px-4 py-2 outline-none focus:border-brand-500" placeholder="Digite aqui..." value={input} onChange={e => setInput(e.target.value)} />
                        <button className="bg-brand-600 text-white p-2 rounded-lg hover:bg-brand-700"><Icons.Send /></button>
                    </form>
                </div>
            );
        };

        const App = ({ user, license, onLogout }) => {
            const [view, setView] = useState('dash');
            const [data, setData] = useState(ClientSystem.getData());
            
            // Formulários e Estados
            const [desc, setDesc] = useState('');
            const [amount, setAmount] = useState('');
            const [cat, setCat] = useState('Casa');
            // FIX: Usar data local correta na inicialização
            const [txDate, setTxDate] = useState(() => {
                const now = new Date();
                // Ajusta o offset para garantir que pegamos o dia local correto YYYY-MM-DD
                const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
                return local.toISOString().split('T')[0];
            });
            const [installments, setInstallments] = useState(1);
            const [hasInst, setHasInst] = useState(false);
            const [type, setType] = useState('expense');
            
            // Goals
            const [goalTitle, setGoalTitle] = useState('');
            const [goalTarget, setGoalTarget] = useState('');

            useEffect(() => {
                ClientSystem.saveData(data);
            }, [data]);

            // Handlers
            const addTransaction = (e) => {
                e.preventDefault();
                const count = hasInst ? parseInt(installments) : 1;
                const val = parseFloat(amount) / count;
                const newT = [];
                // FIX: Forçar meio-dia para evitar problemas de fuso horário
                const baseDate = new Date(txDate + 'T12:00:00');

                for(let i=0; i<count; i++){
                    const d = new Date(baseDate);
                    d.setMonth(baseDate.getMonth() + i);
                    newT.push({
                        id: Date.now() + i, desc: count > 1 ? `${desc} (${i+1}/${count})` : desc,
                        amount: val, type, category: cat, date: d.toISOString()
                    });
                }
                setData(p => ({ ...p, transactions: [...p.transactions, ...newT] }));
                setDesc(''); setAmount(''); setHasInst(false); setInstallments(1); 
                // Reset data para hoje
                const now = new Date();
                const local = new Date(now.getTime() - (now.getTimezoneOffset() * 60000));
                setTxDate(local.toISOString().split('T')[0]);
                
                alert('Lançamento salvo!');
            };

            const delTransaction = (id) => setData(p => ({ ...p, transactions: p.transactions.filter(t => t.id !== id) }));
            const delGoal = (id) => setData(p => ({ ...p, goals: p.goals.filter(g => g.id !== id) }));
            
            const addGoal = (e) => {
                e.preventDefault();
                const newGoal = { id: Date.now(), title: goalTitle, target: parseFloat(goalTarget), saved: 0 };
                setData(p => ({ ...p, goals: [...(p.goals || []), newGoal] }));
                setGoalTitle(''); setGoalTarget('');
            };

            const addSavings = (id, val) => {
                setData(p => ({
                    ...p,
                    goals: p.goals.map(g => g.id === id ? { ...g, saved: g.saved + val } : g)
                }));
            };

            const exportCSV = () => {
                let csv = "Data,Descricao,Categoria,Valor,Tipo\n";
                data.transactions.forEach(r => csv += `${r.date.slice(0,10)},${r.desc},${r.category},${r.amount},${r.type}\n`);
                const link = document.createElement("a");
                link.setAttribute("href", encodeURI("data:text/csv;charset=utf-8," + csv));
                link.setAttribute("download", "meus_gastos.csv");
                document.body.appendChild(link);
                link.click();
            };

            // Cálculos
            const totalInc = data.transactions.filter(t=>t.type==='income').reduce((a,b)=>a+b.amount,0);
            const totalExp = data.transactions.filter(t=>t.type==='expense').reduce((a,b)=>a+b.amount,0);
            const balance = totalInc - totalExp;

            // Chart Data
            const chartData = useMemo(() => {
                const m = {};
                // Agrupando por dia para ver evolução diária
                data.transactions.forEach(t => {
                    const k = t.date.slice(0,10); // YYYY-MM-DD
                    if(!m[k]) m[k] = { name: new Date(t.date).toLocaleDateString().slice(0,5), receita: 0, despesa: 0 };
                    if(t.type === 'income') m[k].receita += t.amount; else m[k].despesa += t.amount;
                });
                return Object.values(m).sort((a,b) => {
                    const dateA = new Date(a.name.split('/').reverse().join('-')); // Simple sort fix attempt, better to sort by key
                    return 0; 
                }).slice(-10); // Show last 10 entries for cleaner chart
            }, [data.transactions]);

            const PERSONAL_CATS = ['Casa', 'Mercado', 'Lazer', 'Saúde', 'Transporte', 'Educação', 'Salário', 'Investimento'];

            return (
                <div className="flex h-screen bg-slate-50 font-sans">
                    {/* Sidebar */}
                    <aside className="w-64 bg-slate-900 text-slate-300 flex-col hidden md:flex">
                        <div className="h-16 flex items-center px-6 border-b border-slate-800 bg-slate-900">
                            <span className="text-white font-bold text-lg tracking-wide truncate">{data.settings?.userName || 'Minha Família'}</span>
                        </div>
                        <nav className="flex-1 py-6 px-3 space-y-1">
                            {[
                                { id: 'dash', icon: <Icons.Home />, label: 'Visão Geral' },
                                { id: 'ai', icon: <Icons.Bot />, label: 'FluxBlue AI', highlight: true },
                                { id: 'finances', icon: <Icons.Wallet />, label: 'Meus Gastos' },
                                { id: 'goals', icon: <Icons.Target />, label: 'Metas & Sonhos' }, // Nova Aba
                                { id: 'reports', icon: <Icons.Chart />, label: 'Relatórios' },
                                { id: 'settings', icon: <Icons.Settings />, label: 'Configurações' },
                            ].map(item => (
                                <button key={item.id} onClick={() => setView(item.id)} 
                                    className={`w-full flex items-center px-4 py-3 text-sm font-medium rounded-lg transition-colors ${view === item.id ? 'bg-brand-600 text-white' : item.highlight ? 'text-brand-400 hover:bg-slate-800 hover:text-white' : 'hover:bg-slate-800 text-slate-400 hover:text-white'}`}>
                                    <span className="mr-3">{item.icon}</span>
                                    {item.label}
                                </button>
                            ))}
                        </nav>
                        <div className="p-4 border-t border-slate-800">
                            <button onClick={onLogout} className="flex items-center text-sm text-red-400 hover:text-red-300 px-2 transition">
                                <span className="mr-2"><Icons.LogOut /></span> Sair
                            </button>
                        </div>
                    </aside>

                    {/* Main Content */}
                    <main className="flex-1 overflow-y-auto">
                        <header className="bg-white border-b border-slate-200 h-16 flex items-center justify-between px-8 sticky top-0 z-10">
                            <h2 className="text-xl font-bold text-slate-800">
                                {view === 'dash' && 'Minhas Finanças'}
                                {view === 'ai' && 'Consultor Financeiro IA'}
                                {view === 'finances' && 'Lançamentos e Despesas'}
                                {view === 'goals' && 'Meus Objetivos de Economia'}
                                {view === 'reports' && 'Análise de Gastos'}
                                {view === 'settings' && 'Meus Dados'}
                            </h2>
                            <button onClick={exportCSV} className="text-sm text-brand-600 font-medium hover:underline flex items-center gap-1"><Icons.Download /> Exportar</button>
                        </header>

                        <div className="p-8 max-w-7xl mx-auto">
                            
                            {view === 'ai' && <AIChat data={data} />}

                            {view === 'dash' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className={`p-4 rounded-lg border-l-4 shadow-sm flex items-start gap-3 ${balance < 0 ? 'bg-red-50 border-red-500 text-red-700' : 'bg-blue-50 border-brand-500 text-brand-900'}`}>
                                        <div className="mt-1"><Icons.Bot /></div>
                                        <div>
                                            <h3 className="font-bold text-sm">Status Financeiro</h3>
                                            <p className="text-sm mt-1">
                                                {balance < 0 ? "Alerta Vermelho: Você está gastando mais do que ganha. Tente cortar itens supérfluos na aba 'Metas'." : 
                                                 "Situação Confortável: Seu saldo está positivo. Que tal guardar um pouco na aba 'Metas & Sonhos'?"}
                                            </p>
                                        </div>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-3 gap-6">
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                            <p className="text-sm text-slate-500 font-bold uppercase mb-1">Ganhos</p>
                                            <p className="text-2xl font-bold text-green-600">R$ {totalInc.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                            <p className="text-sm text-slate-500 font-bold uppercase mb-1">Gastos</p>
                                            <p className="text-2xl font-bold text-red-600">R$ {totalExp.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                            <p className="text-sm text-slate-500 font-bold uppercase mb-1">Sobrou</p>
                                            <p className={`text-2xl font-bold ${balance>=0 ? 'text-brand-600' : 'text-red-600'}`}>R$ {balance.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</p>
                                        </div>
                                    </div>

                                    {/* Chart Corrigido */}
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="text-lg font-bold text-slate-700 mb-4">Fluxo Diário (Últimos Registros)</h3>
                                        <div className="h-80">
                                            {chartData.length > 0 ? (
                                                <ResponsiveContainer width="100%" height="100%">
                                                    <AreaChart data={chartData}>
                                                        <defs>
                                                            <linearGradient id="colorInc" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#22c55e" stopOpacity={0.1}/><stop offset="95%" stopColor="#22c55e" stopOpacity={0}/></linearGradient>
                                                            <linearGradient id="colorExp" x1="0" y1="0" x2="0" y2="1"><stop offset="5%" stopColor="#ef4444" stopOpacity={0.1}/><stop offset="95%" stopColor="#ef4444" stopOpacity={0}/></linearGradient>
                                                        </defs>
                                                        <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                        <XAxis dataKey="name" />
                                                        <YAxis />
                                                        <Tooltip />
                                                        <Area type="monotone" dataKey="receita" stroke="#22c55e" fillOpacity={1} fill="url(#colorInc)" name="Ganhos" />
                                                        <Area type="monotone" dataKey="despesa" stroke="#ef4444" fillOpacity={1} fill="url(#colorExp)" name="Gastos" />
                                                    </AreaChart>
                                                </ResponsiveContainer>
                                            ) : <div className="h-full flex items-center justify-center text-slate-400">Adicione transações para ver o gráfico.</div>}
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'finances' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-800 mb-4 border-b border-slate-100 pb-2">Novo Lançamento</h3>
                                        <form onSubmit={addTransaction} className="grid grid-cols-1 md:grid-cols-12 gap-4 items-end">
                                            <div className="md:col-span-3">
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Data</label>
                                                <input required type="date" className="w-full border border-slate-300 rounded-lg p-2 text-sm outline-none focus:border-brand-500" value={txDate} onChange={e=>setTxDate(e.target.value)} />
                                            </div>
                                            <div className="md:col-span-3">
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Descrição</label>
                                                <input required className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:border-brand-500 outline-none" value={desc} onChange={e=>setDesc(e.target.value)} placeholder="Ex: Mercado" />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Valor (R$)</label>
                                                <input required type="number" step="0.01" className="w-full border border-slate-300 rounded-lg p-2 text-sm focus:border-brand-500 outline-none" value={amount} onChange={e=>setAmount(e.target.value)} placeholder="0,00" />
                                            </div>
                                            <div className="md:col-span-2">
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Tipo</label>
                                                <select className="w-full border border-slate-300 rounded-lg p-2 text-sm bg-white focus:border-brand-500 outline-none" value={type} onChange={e=>setType(e.target.value)}>
                                                    <option value="expense">Despesa (Gasto)</option>
                                                    <option value="income">Receita (Ganho)</option>
                                                </select>
                                            </div>
                                            <div className="md:col-span-2">
                                                <button className="w-full bg-brand-600 hover:bg-brand-700 text-white font-bold py-2 rounded-lg text-sm transition">Salvar</button>
                                            </div>
                                        </form>
                                        
                                        <div className="mt-4">
                                            <div className="flex items-center gap-2 mb-3">
                                                <input type="checkbox" id="inst" checked={hasInst} onChange={e=>setHasInst(e.target.checked)} className="rounded text-brand-600" />
                                                <label htmlFor="inst" className="text-sm text-slate-600">Parcelado? (Cartão)</label>
                                                {hasInst && <input type="number" min="2" max="60" className="w-16 border rounded p-1 text-sm" value={installments} onChange={e=>setInstallments(e.target.value)} />}
                                            </div>
                                            <div className="flex flex-wrap gap-2">
                                                {PERSONAL_CATS.map(c => (
                                                    <button key={c} onClick={()=>setCat(c)} className={`px-3 py-1 rounded-full text-xs border transition ${cat===c ? 'bg-slate-800 text-white border-slate-800' : 'bg-white text-slate-600 border-slate-200 hover:bg-slate-50'}`}>{c}</button>
                                                ))}
                                            </div>
                                        </div>
                                    </div>

                                    <div className="bg-white rounded-xl border border-slate-200 card-shadow overflow-hidden">
                                        <table className="w-full text-left">
                                            <thead className="bg-slate-50 border-b border-slate-200">
                                                <tr><th className="p-4 text-xs font-bold text-slate-500 uppercase">Data</th><th className="p-4 text-xs font-bold text-slate-500 uppercase">Descrição</th><th className="p-4 text-xs font-bold text-slate-500 uppercase">Categoria</th><th className="p-4 text-xs font-bold text-slate-500 uppercase">Valor</th><th className="p-4 text-right"></th></tr>
                                            </thead>
                                            <tbody className="divide-y divide-slate-100 text-sm">
                                                {data.transactions.slice().reverse().map(t => (
                                                    <tr key={t.id} className="hover:bg-slate-50">
                                                        <td className="p-4 text-slate-500 font-mono">{new Date(t.date).toLocaleDateString()}</td>
                                                        <td className="p-4 font-medium text-slate-800">{t.desc}</td>
                                                        <td className="p-4"><span className="px-2 py-1 bg-slate-100 rounded text-xs text-slate-600 border border-slate-200">{t.category}</span></td>
                                                        <td className={`p-4 font-bold ${t.type==='income'?'text-green-600':'text-red-600'}`}>R$ {t.amount.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                                        <td className="p-4 text-right"><button onClick={()=>delTransaction(t.id)} className="text-slate-400 hover:text-red-500"><Icons.Trash /></button></td>
                                                    </tr>
                                                ))}
                                                {data.transactions.length===0 && <tr><td colSpan="5" className="p-8 text-center text-slate-400">Nenhum lançamento.</td></tr>}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            )}

                            {view === 'goals' && (
                                <div className="space-y-6 animate-fade-in">
                                    <div className="bg-gradient-to-r from-blue-600 to-indigo-600 rounded-xl p-6 text-white shadow-lg">
                                        <h2 className="text-2xl font-bold mb-2">Por que não gastar?</h2>
                                        <p className="opacity-90">Cada real economizado hoje é um passo mais perto dos seus sonhos. Defina suas metas abaixo e acompanhe seu progresso!</p>
                                    </div>

                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                        <h3 className="font-bold text-slate-800 mb-4">Nova Meta</h3>
                                        <form onSubmit={addGoal} className="flex gap-4 items-end">
                                            <div className="flex-1">
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Nome do Sonho</label>
                                                <input required className="w-full border rounded p-2 text-sm" placeholder="Ex: Viagem Disney" value={goalTitle} onChange={e=>setGoalTitle(e.target.value)} />
                                            </div>
                                            <div className="w-32">
                                                <label className="block text-xs font-bold text-slate-500 mb-1">Valor (R$)</label>
                                                <input required type="number" className="w-full border rounded p-2 text-sm" placeholder="0,00" value={goalTarget} onChange={e=>setGoalTarget(e.target.value)} />
                                            </div>
                                            <button className="bg-brand-600 text-white font-bold px-4 py-2 rounded text-sm hover:bg-brand-700">Criar</button>
                                        </form>
                                    </div>

                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        {(data.goals || []).map(g => {
                                            const pct = Math.min((g.saved / g.target) * 100, 100);
                                            return (
                                                <div key={g.id} className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                                    <div className="flex justify-between items-start mb-4">
                                                        <div>
                                                            <h3 className="font-bold text-lg text-slate-800">{g.title}</h3>
                                                            <p className="text-xs text-slate-500">Meta: R$ {g.target.toLocaleString()}</p>
                                                        </div>
                                                        <button onClick={()=>delGoal(g.id)} className="text-slate-300 hover:text-red-500"><Icons.Trash /></button>
                                                    </div>
                                                    <div className="mb-2 flex justify-between text-sm">
                                                        <span className="font-bold text-green-600">Guardado: R$ {g.saved.toLocaleString()}</span>
                                                        <span className="font-bold text-brand-600">{pct.toFixed(0)}%</span>
                                                    </div>
                                                    <div className="w-full bg-slate-100 rounded-full h-3 mb-4">
                                                        <div className="bg-brand-500 h-3 rounded-full progress-bar-striped transition-all duration-500" style={{width: `${pct}%`}}></div>
                                                    </div>
                                                    <div className="flex gap-2">
                                                        <button onClick={()=>addSavings(g.id, 50)} className="flex-1 bg-green-50 text-green-700 border border-green-200 text-xs font-bold py-2 rounded hover:bg-green-100">+ R$ 50</button>
                                                        <button onClick={()=>addSavings(g.id, 100)} className="flex-1 bg-green-50 text-green-700 border border-green-200 text-xs font-bold py-2 rounded hover:bg-green-100">+ R$ 100</button>
                                                    </div>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}

                            {view === 'reports' && (
                                <div className="space-y-6 animate-fade-in">
                                    <h1 className="text-2xl font-bold text-slate-800">Relatórios Detalhados</h1>
                                    <p className="text-slate-500">Veja onde você pode cortar gastos.</p>
                                    
                                    <div className="grid grid-cols-1 md:grid-cols-2 gap-6">
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow h-80">
                                            <h3 className="font-bold text-slate-800 mb-4">Gastos por Dia</h3>
                                            <ResponsiveContainer width="100%" height="100%">
                                                <BarChart data={chartData}>
                                                    <CartesianGrid strokeDasharray="3 3" vertical={false} />
                                                    <XAxis dataKey="name" />
                                                    <YAxis />
                                                    <Tooltip />
                                                    <Bar dataKey="despesa" fill="#ef4444" radius={[4, 4, 0, 0]} name="Gasto Diário" />
                                                </BarChart>
                                            </ResponsiveContainer>
                                        </div>
                                        <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow">
                                            <h3 className="font-bold text-slate-800 mb-4">Resumo</h3>
                                            <ul className="space-y-3 text-sm">
                                                <li className="flex justify-between p-3 bg-slate-50 rounded"><span>Total Ganho</span> <span className="font-bold text-green-600">R$ {totalInc.toFixed(2)}</span></li>
                                                <li className="flex justify-between p-3 bg-slate-50 rounded"><span>Total Gasto</span> <span className="font-bold text-red-600">R$ {totalExp.toFixed(2)}</span></li>
                                                <li className="flex justify-between p-3 bg-brand-50 rounded border border-brand-100"><span>No Bolso (Saldo)</span> <span className="font-bold text-brand-700">R$ {balance.toFixed(2)}</span></li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            )}

                            {view === 'settings' && (
                                <div className="animate-fade-in max-w-lg">
                                    <div className="bg-white p-6 rounded-xl border border-slate-200 card-shadow space-y-4">
                                        <h3 className="font-bold text-slate-800 border-b border-slate-100 pb-2">Meus Dados</h3>
                                        <div>
                                            <label className="block text-xs font-bold text-slate-500 mb-1">Nome de Exibição</label>
                                            <input className="w-full border border-slate-300 rounded p-2 text-sm" value={data.settings?.userName || ''} onChange={e => {
                                                const newSettings = { ...data.settings, userName: e.target.value };
                                                setData({ ...data, settings: newSettings });
                                            }} />
                                        </div>
                                        <div className="pt-4 text-xs text-slate-400">
                                            <p>Versão: FluxBlue Personal v4.0</p>
                                            <p>ID da Licença: {license.key}</p>
                                        </div>
                                    </div>
                                </div>
                            )}

                        </div>
                    </main>
                </div>
            );
        };

        const Root = () => {
            const [session, setSession] = useState(null);
            useEffect(() => ClientSystem.init(), []);
            return session ? <App user={session.email} license={session.license} onLogout={()=>setSession(null)} /> 
                           : <Login onSuccess={(lic, email) => setSession({license: lic, email})} />;
        };

        ReactDOM.createRoot(document.getElementById('root')).render(<Root />);
    </script>
</body>
</html>
